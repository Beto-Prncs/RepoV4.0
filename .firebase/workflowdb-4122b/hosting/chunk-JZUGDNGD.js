import{L as D,M as F,S as I,Z as E}from"./chunk-ETTNRBRS.js";import{m as P}from"./chunk-M4NTTXXQ.js";import{B as f,P as w,U as _,_ as b,n as c,o as h,p as l,s as d}from"./chunk-RQ52NV5F.js";import{g}from"./chunk-OIKEWKHE.js";var y={production:!1,appUrl:"workflowdb-4122b.web.app",firebaseConfig:{apiKey:"AIzaSyB02aFRJQaUZV4PH-1UilL0G1qR011UMOo",authDomain:"workflowdb-4122b.firebaseapp.com",projectId:"workflowdb-4122b",storageBucket:"workflowdb-4122b.firebasestorage.app",messagingSenderId:"1053802838055",appId:"1:1053802838055:web:17ffaf05c2fe045c77b602",persistence:"session"},cloudinary:{cloudName:"dqv73l7uc",apiKey:"747314796397951",uploadPreset:"profile_images"}};var O=(()=>{class u{cloudName=y.cloudinary.cloudName;uploadPreset=y.cloudinary.uploadPreset;uploadUrl=`https://api.cloudinary.com/v1_1/${this.cloudName}/image/upload`;imageCache=new Map;http=b(P);firestore=b(F);uploadImage(t,r,a="reportes"){if(!t||!t.type.includes("image"))return l(()=>new Error("El archivo debe ser una imagen"));let i=`${r}_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,e=new FormData;return e.append("file",t),e.append("upload_preset",this.uploadPreset),e.append("public_id",i),e.append("folder",a),e.append("tags",a+","+r),e.append("quality","auto"),e.append("fetch_format","auto"),this.http.post(this.uploadUrl,e).pipe(d(n=>{let o=n.secure_url;return this.cacheImageUrl(i,o),o}),f(n=>(console.error("Error al subir imagen a Cloudinary:",n),l(()=>new Error("Error al subir imagen: "+(n.message||"Intente nuevamente"))))))}uploadProfileImage(t,r,a="Usuario",i="Foto_Perfil"){if(!t||!t.type.includes("image"))return l(()=>new Error("El archivo debe ser una imagen"));if(!r)return l(()=>new Error("ID de documento no disponible"));let e=new FormData;e.append("file",t),e.append("upload_preset",this.uploadPreset);let n=`${a}_${r}_${Date.now()}`;return e.append("public_id",n),e.append("folder",a),e.append("tags",a+","+r),e.append("quality","auto"),e.append("fetch_format","auto"),this.http.post(this.uploadUrl,e).pipe(w(o=>{let p=o.secure_url;if(this.cacheImageUrl(n,p),a==="Reportes"&&i==="evidenceImages"){let s=I(this.firestore,a,r);return c(E(s,{[i]:D(p)})).pipe(d(()=>p))}else{let s=I(this.firestore,a,r);return c(E(s,{[i]:p})).pipe(d(()=>p))}}),f(o=>(console.error("Error al subir imagen o actualizar documento:",o),l(()=>new Error("Error al procesar imagen: "+(o.message||"Intente nuevamente"))))))}uploadMultipleImages(t,r,a="Reportes"){if(!t||t.length===0)return h([]);let i=t.filter(n=>n.type.includes("image"));if(i.length===0)return h([]);let e=i.map(n=>c(this.optimizeImage(n)).pipe(w(o=>this.uploadImage(o,`${a}_${r}`,a))));return c(Promise.all(e.map(n=>n.toPromise().catch(o=>(console.error("Error en subida individual:",o),null))))).pipe(d(n=>n.filter(o=>o!==null)))}optimizeImage(t,r=1200){return g(this,null,function*(){return new Promise((a,i)=>{try{let e=new FileReader;e.onload=n=>{let o=new Image;o.onload=()=>{let p=o.width,s=o.height;p>r&&(s=Math.round(s*r/p),p=r);let m=document.createElement("canvas");m.width=p,m.height=s;let v=m.getContext("2d");if(!v){i(new Error("No se pudo obtener el contexto 2D del canvas"));return}v.drawImage(o,0,0,p,s),m.toBlob(U=>{if(!U){i(new Error("Error al generar blob"));return}let C=new File([U],t.name,{type:"image/jpeg",lastModified:Date.now()});a(C)},"image/jpeg",.85)},o.onerror=()=>{i(new Error("Error al cargar la imagen para optimizaci\xF3n"))},o.src=n.target?.result},e.onerror=()=>{i(new Error("Error al leer el archivo para optimizaci\xF3n"))},e.readAsDataURL(t)}catch(e){i(e)}})})}updateProfileImage(t,r){return g(this,null,function*(){try{let a=yield this.optimizeImage(t);return this.uploadProfileImage(a,r)}catch(a){return l(()=>a)}})}cacheImageUrl(t,r){this.imageCache.set(t,r)}getCachedImageUrl(t){return this.imageCache.get(t)||null}removeCachedImage(t){this.imageCache.delete(t)}extractPublicId(t){try{let r=t.split("/"),a=r.findIndex(o=>o==="upload");if(a===-1||a+2>=r.length)return null;let e=r.slice(a+2).join("/"),n=e.lastIndexOf(".");return n!==-1&&(e=e.substring(0,n)),e}catch(r){return console.error("Error al extraer public_id:",r),null}}static \u0275fac=function(r){return new(r||u)};static \u0275prov=_({token:u,factory:u.\u0275fac,providedIn:"root"})}return u})();export{O as a};
//# sourceMappingURL=chunk-JZUGDNGD.js.map
