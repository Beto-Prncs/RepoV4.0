import{a as O,c as z,d as x,f as S,i as _}from"./chunk-BXWCDTY3.js";import{a as L}from"./chunk-HMRK7SWW.js";import{J as W,K as q,M as R,N as T,O as l,P as G,Q as u,R as m,S as k,U as h,W as E,X as c}from"./chunk-7XAWW6QG.js";import{B as v,Q as P,T as Q,Z as b,c as N,o as d,s as w}from"./chunk-GCXAMRXK.js";import{a as C,b as B,g as f}from"./chunk-OIKEWKHE.js";var oe=(()=>{class y{firestore=b(q);storage=b(O);authService=b(L);constructor(){}getPendingReportesByWorker(e){if(!e)return console.error("UserId es requerido para obtener reportes pendientes"),d([]);console.log("Getting pending reports for worker:",e);let r=l(this.firestore,"Reportes"),t=h(r,c("IdUsuario","==",e),c("estado","==","Pendiente"));return console.log("Query params:",{workerId:e,estado:"Pendiente"}),R(t,{idField:"IdReporte"}).pipe(P(o=>{console.log("Raw reports from Firestore:",JSON.stringify(o))}),w(o=>(console.log("Processing reports:",o.length),this.processReportDates(o))),P(o=>{console.log("Processed reports:",o.length)}),v(o=>(console.error("Error getting pending reports:",o),d([]))))}getCompletedReportesByWorker(e){if(!e)return console.error("UserId es requerido para obtener reportes completados"),d([]);console.log("Buscando reportes completados para userId:",e);let r=l(this.firestore,"Reportes"),t=h(r,c("IdUsuario","==",e),c("estado","==","Completado"));return console.log("Query params for completed reports:",{workerId:e,estado:"Completado"}),R(t,{idField:"IdReporte"}).pipe(P(o=>{console.log("Raw completed reports from Firestore:",JSON.stringify(o))}),w(o=>(console.log("Processing completed reports:",o.length),this.processReportDates(o))),P(o=>{console.log("Processed completed reports:",o.length)}),v(o=>(console.error("Error getting completed reports:",o),d([]))))}processReportDates(e){return console.log("Processing dates for reports:",e),e.map(r=>{if(!r)return console.error("Found undefined report in array"),null;console.log("Processing report:",r.IdReporte);let t=B(C({},r),{fecha:r.fecha?this.convertToDate(r.fecha):new Date,fechaCompletado:r.fechaCompletado?this.convertToDate(r.fechaCompletado):void 0,fechaActualizacion:r.fechaActualizacion?this.convertToDate(r.fechaActualizacion):void 0,fechaGeneracionPdf:r.fechaGeneracionPdf?this.convertToDate(r.fechaGeneracionPdf):void 0});return console.log("Processed report dates:",{id:t.IdReporte,fecha:t.fecha,estado:t.estado}),t}).filter(r=>r!==null)}convertToDate(e){if(!e)return console.warn("Attempted to convert null/undefined date"),new Date;try{return e instanceof W||e&&typeof e.toDate=="function"?e.toDate():e instanceof Date?e:typeof e=="number"?e<1e11?new Date(e*1e3):new Date(e):e&&e.seconds&&typeof e.seconds=="number"?new Date(e.seconds*1e3+(e.nanoseconds||0)/1e6):typeof e=="string"?new Date(e):(console.warn("Unknown date format:",e),new Date)}catch(r){return console.error("Error converting date:",r,e),new Date}}updateReporteStatus(e,r,t){return f(this,null,function*(){try{let o=yield this.authService.getCurrentUser();if(!o)throw new Error("No hay usuario autenticado");let s=u(this.firestore,"Reportes",e),n=yield m(s);if(!n.exists())throw new Error("El reporte no existe");let a=n.data(),i=yield m(u(this.firestore,"Usuario",o.uid));if(!i.exists())throw new Error("Usuario no encontrado");let U=i.data().Rol==="admin",D=a.IdUsuario===o.uid;if(!U&&!D)throw new Error("No tiene permisos para actualizar este reporte");let p={estado:r,fechaActualizacion:new Date};r==="Completado"&&(p.fechaCompletado=new Date,t&&(p.descripcionCompletado=t)),yield E(s,p),console.log("Report status updated successfully")}catch(o){throw console.error("Error updating report status:",o),o}})}storePdfForReporte(e,r){return f(this,null,function*(){try{console.log("Storing PDF for report:",e);let t=`reportes_pdf/${e}.pdf`,o=S(this.storage,t),s=r.split(",")[1];yield _(o,s,"base64");let n=yield x(o);return console.log("PDF stored successfully, URL:",n),yield this.updateReporteWithPdfInfo(e,n),n}catch(t){throw console.error("Error storing PDF for report:",t),t}})}getPdfUrlForReporte(e){return f(this,null,function*(){try{console.log("Getting PDF URL for report:",e);let r=u(this.firestore,"Reportes",e),t=yield m(r);if(t.exists()){let a=t.data();if(a.pdfUrl)return console.log("Found PDF URL in report document:",a.pdfUrl),a.pdfUrl}let o=`reportes_pdf/${e}.pdf`,s=S(this.storage,o),n=yield x(s);return yield this.updateReporteWithPdfInfo(e,n),n}catch(r){return console.error("PDF not found or access error:",r),null}})}updateReporteWithPdfInfo(e,r){return f(this,null,function*(){try{let t=u(this.firestore,"Reportes",e);yield E(t,{pdfUrl:r,reportePdfGenerado:!0,fechaGeneracionPdf:new Date}),console.log("Report PDF info updated successfully with URL:",r)}catch(t){throw console.error("Error updating report PDF info:",t),t}})}deletePdfForReporte(e){return f(this,null,function*(){try{let r=`reportes_pdf/${e}.pdf`,t=S(this.storage,r);yield z(t),console.log("PDF deleted successfully")}catch(r){throw console.error("Error deleting PDF:",r),r}})}deleteReporte(e){return f(this,null,function*(){try{let r=yield this.authService.getCurrentUser();if(!r)throw new Error("No hay usuario autenticado");let t=yield m(u(this.firestore,"Usuario",r.uid));if(!t.exists())throw new Error("Usuario no encontrado");if(t.data().Rol!=="admin")throw new Error("Solo los administradores pueden eliminar reportes");let s=u(this.firestore,"Reportes",e);if(!(yield m(s)).exists())throw new Error("El reporte no existe");try{yield this.deletePdfForReporte(e)}catch(a){console.warn("No se pudo eliminar el PDF del reporte:",a)}console.log("Eliminando reporte:",e),yield G(s),console.log("Reporte eliminado exitosamente")}catch(r){throw console.error("Error al eliminar reporte:",r),r}})}assignReporte(e){return f(this,null,function*(){try{console.log("Attempting to assign report with data:",JSON.stringify(e));let r=yield this.authService.getCurrentUser();if(!r)throw new Error("No hay usuario autenticado");let t=yield m(u(this.firestore,"Usuario",r.uid));if(!t.exists())throw new Error("Usuario administrador no encontrado");if(t.data().Rol!=="admin")throw new Error("No tiene permisos para crear reportes");let s=l(this.firestore,"Usuario");console.log("Searching for worker with Username:",e.IdUsuario);let n=h(s,c("Username","==",e.IdUsuario),c("Rol","==","worker")),a=yield k(n);if(a.empty){console.error("Worker not found. Trying alternative search...");let F=h(s,c("Username","==",e.IdUsuario)),A=yield k(F);if(A.empty)throw new Error("Usuario trabajador no encontrado");let j=A.docs[0].id;console.log("Found worker with different role:",j);let J=l(this.firestore,"Reportes"),$={fecha:new Date,estado:"Pendiente",IdEmpresa:e.IdEmpresa,IdUsuario:j,Tipo_Trabajo:e.Tipo_Trabajo,jobDescription:e.jobDescription,location:e.location,priority:e.priority,departamento:e.departamento,fechaActualizacion:new Date},I=yield T(J,$);return yield E(u(this.firestore,"Reportes",I.id),{IdReporte:I.id}),console.log("Reporte creado exitosamente:",I.id),I.id}let g=a.docs[0].id;console.log("Found worker:",g);let U=l(this.firestore,"Reportes"),D={fecha:new Date,estado:"Pendiente",IdEmpresa:e.IdEmpresa,IdUsuario:g,Tipo_Trabajo:e.Tipo_Trabajo,jobDescription:e.jobDescription,location:e.location,priority:e.priority,departamento:e.departamento,fechaActualizacion:new Date};console.log("Creating report with data:",JSON.stringify(D));let p=yield T(U,D);return yield E(u(this.firestore,"Reportes",p.id),{IdReporte:p.id}),console.log("Reporte creado exitosamente:",p.id),p.id}catch(r){throw console.error("Error al asignar reporte:",r),r}})}getReportes(){console.log("Obteniendo todos los reportes");let e=l(this.firestore,"Reportes");return R(e,{idField:"IdReporte"}).pipe(w(r=>(console.log("Reportes recuperados:",r),this.processReportDates(r))))}getReportesByDepartamento(e){if(!e)return console.error("Departamento es requerido para obtener reportes"),d([]);console.log("Buscando reportes para departamento:",e);let r=l(this.firestore,"Reportes"),t=h(r,c("departamento","==",e));return R(t,{idField:"IdReporte"}).pipe(w(o=>(console.log("Reportes encontrados para departamento:",o),this.processReportDates(o))))}getReportesByEmpresa(e){if(!e)return console.error("ID de empresa es requerido para obtener reportes"),d([]);console.log("Buscando reportes para empresa:",e);let r=l(this.firestore,"Reportes"),t=h(r,c("IdEmpresa","==",e));return R(t,{idField:"IdReporte"}).pipe(w(o=>(console.log("Reportes encontrados para empresa:",o),this.processReportDates(o))))}getReportesByPriority(e){if(!e)return console.error("Prioridad es requerida para obtener reportes"),d([]);console.log("Buscando reportes por prioridad:",e);let r=l(this.firestore,"Reportes"),t=h(r,c("priority","==",e));return R(t,{idField:"IdReporte"}).pipe(w(o=>(console.log("Reportes encontrados por prioridad:",o),this.processReportDates(o))))}getFilteredReportes(){return f(this,null,function*(){try{let e=yield this.authService.getCurrentUser();if(!e)return console.error("No hay usuario autenticado"),d([]);let r=yield this.authService.getUserData(e.uid);return r?r.Rol==="admin"&&r.NivelAdmin==="3"?this.getReportesByCreator(e.uid):this.getReportes():(console.error("Datos de usuario no encontrados"),d([]))}catch(e){return console.error("Error al filtrar reportes:",e),d([])}})}getReportesByCreator(e){return new N(r=>{this.authService.getUsersByCreator(e).then(t=>{let o=t.map(i=>i.IdUsuario);if(o.length===0){r.next([]),r.complete();return}let s=l(this.firestore,"Reportes"),n=this.chunkArray(o,10),a=[];n.forEach(i=>{let g=h(s,c("IdUsuario","in",i)),U=k(g).then(D=>{let p=[];return D.forEach(F=>{p.push(C({IdReporte:F.id},F.data()))}),this.processReportDates(p)});a.push(U)}),Promise.all(a).then(i=>{let g=i.flat();r.next(g),r.complete()}).catch(i=>{console.error("Error obteniendo reportes:",i),r.error(i)})}).catch(t=>{console.error("Error obteniendo usuarios:",t),r.error(t)})})}chunkArray(e,r){let t=[];for(let o=0;o<e.length;o+=r)t.push(e.slice(o,o+r));return t}static \u0275fac=function(r){return new(r||y)};static \u0275prov=Q({token:y,factory:y.\u0275fac,providedIn:"root"})}return y})();export{oe as a};
//# sourceMappingURL=chunk-SZLL3TPF.js.map
