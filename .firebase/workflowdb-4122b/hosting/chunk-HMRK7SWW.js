import{b as x,c as v}from"./chunk-NOIAGMWN.js";import{B as D,E as S,F as k,G as A,H as B,I as C,K as P,O as c,Q as m,R,S as u,U as h,W as I,X as l,w as U,x as b,y as E}from"./chunk-7XAWW6QG.js";import{u as p}from"./chunk-OLDY7IAS.js";import{T as g,Z as f,g as y}from"./chunk-GCXAMRXK.js";import{a as n,b as d,g as s}from"./chunk-OIKEWKHE.js";var T=v("Browser",{web:()=>import("./chunk-B6NEVDVM.js").then(i=>new i.BrowserWeb)});var z=(()=>{class i{auth=f(E);firestore=f(P);router=f(p);currentUserSubject=new y(null);currentUser$=this.currentUserSubject.asObservable();constructor(){this.initAuthListener()}initAuthListener(){this.auth.onAuthStateChanged(e=>s(this,null,function*(){if(e){let r=yield this.getUserData(e.uid);this.currentUserSubject.next(r)}else this.currentUserSubject.next(null)}))}getUserData(e){return s(this,null,function*(){try{let r=yield R(m(this.firestore,"Usuario",e));return r.exists()?d(n({},r.data()),{IdUsuario:e}):null}catch(r){return console.error("Error obteniendo datos del usuario:",r),null}})}getUserByUsername(e){return s(this,null,function*(){try{let r=c(this.firestore,"Usuario"),t=h(r,l("Username","==",e)),o=yield u(t);if(!o.empty){let a=o.docs[0];return d(n({},a.data()),{IdUsuario:a.id})}return null}catch(r){return console.error("Error obteniendo usuario por username:",r),null}})}getUserByEmail(e){return s(this,null,function*(){try{let r=c(this.firestore,"Usuario"),t=h(r,l("Correo","==",e)),o=yield u(t);if(!o.empty){let a=o.docs[0];return d(n({},a.data()),{IdUsuario:a.id})}return null}catch(r){return console.error("Error obteniendo usuario por email:",r),null}})}isAdmin(e){return s(this,null,function*(){return(yield this.getUserData(e))?.Rol==="admin"})}isWorker(e){return s(this,null,function*(){return(yield this.getUserData(e))?.Rol==="worker"})}getCurrentUser(){return s(this,null,function*(){return new Promise(e=>{let r=this.auth.onAuthStateChanged(t=>{r(),e(t)})})})}getUserToken(){return s(this,null,function*(){try{let e=this.auth.currentUser;return e?yield e.getIdToken():null}catch(e){return console.error("Error obteniendo token:",e),null}})}signOut(){return s(this,null,function*(){try{let e=window.location.origin;this.currentUserSubject.next(null),localStorage.clear(),sessionStorage.clear(),yield this.auth.signOut(),["firebaseLocalStorageDb","firebaseAuth","firebaseinstallations-database"].forEach(t=>{let o=indexedDB.deleteDatabase(t);o.onsuccess=()=>console.log(`${t} eliminada correctamente`),o.onerror=()=>console.warn(`Error al eliminar ${t}`)}),setTimeout(()=>{window.location.href=`${e}/login?forceRefresh=true&t=${Date.now()}`},300)}catch(e){console.error("Error al cerrar sesi\xF3n:",e),window.location.href="/login?error=true&t="+Date.now()}})}clearFirebaseTokens(){let e=[];for(let r=0;r<localStorage.length;r++){let t=localStorage.key(r);t&&(t.startsWith("firebase:")||t.includes("firebaseLocalStorageDb")||t.includes("firebaseAuth"))&&e.push(t)}e.forEach(r=>localStorage.removeItem(r))}clearAuthCookies(){if(typeof document>"u")return;let e=["firebase","firebaseAuth","G_AUTH","G_AUTHUSER","goog","google"],r=document.cookie.split(";");for(let t of r){let o=t.indexOf("="),a=o>-1?t.substr(0,o).trim():t.trim();e.some($=>a.toLowerCase().includes($.toLowerCase()))&&(document.cookie=`${a}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`,document.cookie=`${a}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${window.location.hostname}`,document.cookie=`${a}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname}`)}}cleanGoogleAuth(){return s(this,null,function*(){if(typeof window>"u")return;let e=window.google;if(e?.accounts?.id)try{e.accounts.id.disableAutoSelect();let r=this.auth.currentUser;if(r?.email)return new Promise(t=>{e.accounts.id.revoke(r.email,()=>{console.log("Google token revocado exitosamente"),t()})})}catch(r){console.warn("Google auth cleanup failed (non-critical):",r)}})}clearIndexedDB(){return s(this,null,function*(){try{let e=["firebaseLocalStorageDb","firebase-auth-container","firebase-installations-database"];for(let r of e)try{yield window.indexedDB.deleteDatabase(r)}catch(t){console.warn(`No se pudo eliminar la base de datos ${r}:`,t)}}catch(e){console.warn("Error al limpiar IndexedDB:",e)}})}cleanCapacitorAuth(){return s(this,null,function*(){try{x.isPluginAvailable("Browser")&&(yield T.close())}catch(e){console.log("No se pudo cerrar el navegador en Capacitor:",e)}})}isAuthenticated(){return this.auth.currentUser!==null}setPersistenceSession(){return s(this,null,function*(){return k(this.auth,b)})}signInWithEmailPassword(e,r){return s(this,null,function*(){return A(this.auth,e,r)})}loginWithGoogle(){return s(this,null,function*(){yield this.setPersistenceSession();let e=new U;return e.addScope("email"),B(this.auth,e)})}sendPasswordResetEmail(e){return s(this,null,function*(){if(!(yield this.getUserByEmail(e)))throw new Error("El correo electr\xF3nico no est\xE1 registrado en el sistema");return S(this.auth,e,{url:`${window.location.origin}/login`,handleCodeInApp:!0})})}verifyPasswordResetCode(e){return s(this,null,function*(){return C(this.auth,e)})}confirmPasswordReset(e,r){return s(this,null,function*(){yield D(this.auth,e,r);try{let t=yield this.verifyPasswordResetCode(e),o=yield this.getUserByEmail(t);if(o&&o.IdUsuario){let a=m(this.firestore,"Usuario",o.IdUsuario);yield I(a,{Password:r})}}catch(t){console.error("Error actualizando contrase\xF1a en Firestore:",t)}})}getFilteredUsers(){return s(this,null,function*(){try{let e=yield this.getCurrentUser();if(!e)throw new Error("No hay usuario autenticado");let r=yield this.getUserData(e.uid);if(!r)throw new Error("No se encontraron datos del usuario");return r.Rol==="admin"&&r.NivelAdmin==="3"?this.getUsersByCreator(e.uid):this.getAllUsers()}catch(e){return console.error("Error al filtrar usuarios:",e),[]}})}getUsersCreatedBy(e){return s(this,null,function*(){try{let r=h(c(this.firestore,"Usuario"),l("createdBy","==",e));return(yield u(r)).docs.map(o=>d(n({},o.data()),{IdUsuario:o.id}))}catch(r){return console.error("Error obteniendo usuarios creados por el admin:",r),[]}})}getWorkersCreatedBy(e){return s(this,null,function*(){try{let r=h(c(this.firestore,"Usuario"),l("createdBy","==",e),l("Rol","==","worker"));return(yield u(r)).docs.map(o=>d(n({},o.data()),{IdUsuario:o.id}))}catch(r){return console.error("Error obteniendo trabajadores creados por el admin:",r),[]}})}getUsersByCreator(e){return s(this,null,function*(){try{let r=c(this.firestore,"Usuario"),t=h(r,l("createdBy","==",e)),o=yield u(t),a=[];return o.forEach(w=>{a.push(n({IdUsuario:w.id},w.data()))}),a}catch(r){return console.error("Error obteniendo usuarios por creador:",r),[]}})}getAllUsers(){return s(this,null,function*(){try{let e=c(this.firestore,"Usuario"),r=yield u(e),t=[];return r.forEach(o=>{t.push(n({IdUsuario:o.id},o.data()))}),t}catch(e){return console.error("Error obteniendo todos los usuarios:",e),[]}})}static \u0275fac=function(r){return new(r||i)};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();export{z as a};
//# sourceMappingURL=chunk-HMRK7SWW.js.map
