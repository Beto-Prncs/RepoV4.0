import{a as L,c as J,d as x,f as v,i as _}from"./chunk-YK542MCL.js";import{a as z}from"./chunk-ZC25YYBL.js";import{K as q,M as G,O as w,P as T,Q as d,R as O,S as u,T as m,U as E,X as f,Z as F,_ as c}from"./chunk-ETTNRBRS.js";import{B as k,R as y,U as W,_ as C,c as N,n as Q,o as i,s as g}from"./chunk-RQ52NV5F.js";import{a as S,b as B,g as h}from"./chunk-OIKEWKHE.js";var te=(()=>{class U{firestore=C(G);storage=C(L);authService=C(z);constructor(){}getPendingReportesByWorker(e){if(!e)return console.error("UserId es requerido para obtener reportes pendientes"),i([]);console.log("Getting pending reports for worker:",e);let r=d(this.firestore,"Reportes"),t=f(r,c("IdUsuario","==",e),c("estado","==","Pendiente"));return console.log("Query params:",{workerId:e,estado:"Pendiente"}),w(t,{idField:"IdReporte"}).pipe(y(o=>{console.log("Raw reports from Firestore:",JSON.stringify(o))}),g(o=>(console.log("Processing reports:",o.length),this.processReportDates(o))),y(o=>{console.log("Processed reports:",o.length)}),k(o=>(console.error("Error getting pending reports:",o),i([]))))}getCompletedReportesByWorker(e){if(!e)return console.error("UserId es requerido para obtener reportes completados"),i([]);console.log("Buscando reportes completados para userId:",e);let r=d(this.firestore,"Reportes"),t=f(r,c("IdUsuario","==",e),c("estado","==","Completado"));return console.log("Query params for completed reports:",{workerId:e,estado:"Completado"}),Q(E(t)).pipe(y(o=>{console.log("Query returned snapshot with",o.size,"documents"),o.docs.forEach(s=>{console.log("Found document with ID:",s.id)})}),g(o=>{let s=[];return o.forEach(n=>{console.log("Processing doc data:",JSON.stringify(n.data())),s.push(S({IdReporte:n.id},n.data()))}),this.processReportDates(s)}),y(o=>{console.log("Processed completed reports:",o.length)}),k(o=>(console.error("Error getting completed reports:",o),i([]))))}getReportesByStatus(e){if(!e)return console.error("Status is required to get reports"),i([]);console.log("Getting reports with status:",e);let r=d(this.firestore,"Reportes"),t=f(r,c("estado","==",e));return w(t,{idField:"IdReporte"}).pipe(y(o=>{console.log("Raw reports from Firestore:",JSON.stringify(o))}),g(o=>(console.log("Processing reports:",o.length),this.processReportDates(o))),k(o=>(console.error("Error getting reports by status:",o),i([]))))}processReportDates(e){return console.log("Processing dates for reports:",e),e.map(r=>{if(!r)return console.error("Found undefined report in array"),null;console.log("Processing report:",r.IdReporte);let t=B(S({},r),{fecha:r.fecha?this.convertToDate(r.fecha):new Date,fechaCompletado:r.fechaCompletado?this.convertToDate(r.fechaCompletado):void 0,fechaActualizacion:r.fechaActualizacion?this.convertToDate(r.fechaActualizacion):void 0,fechaGeneracionPdf:r.fechaGeneracionPdf?this.convertToDate(r.fechaGeneracionPdf):void 0});return console.log("Processed report dates:",{id:t.IdReporte,fecha:t.fecha,estado:t.estado}),t}).filter(r=>r!==null)}convertToDate(e){if(!e)return console.warn("Attempted to convert null/undefined date"),new Date;try{return e instanceof q||e&&typeof e.toDate=="function"?e.toDate():e instanceof Date?e:typeof e=="number"?e<1e11?new Date(e*1e3):new Date(e):e&&e.seconds&&typeof e.seconds=="number"?new Date(e.seconds*1e3+(e.nanoseconds||0)/1e6):typeof e=="string"?new Date(e):(console.warn("Unknown date format:",e),new Date)}catch(r){return console.error("Error converting date:",r,e),new Date}}updateReporteStatus(e,r,t){return h(this,null,function*(){try{let o=yield this.authService.getCurrentUser();if(!o)throw new Error("No hay usuario autenticado");let s=u(this.firestore,"Reportes",e),n=yield m(s);if(!n.exists())throw new Error("El reporte no existe");let a=n.data(),p=yield m(u(this.firestore,"Usuario",o.uid));if(!p.exists())throw new Error("Usuario no encontrado");let P=p.data().Rol==="admin",D=a.IdUsuario===o.uid;if(!P&&!D)throw new Error("No tiene permisos para actualizar este reporte");let l={estado:r,fechaActualizacion:new Date};r==="Completado"&&(l.fechaCompletado=new Date,t&&(l.descripcionCompletado=t)),yield F(s,l),console.log("Report status updated successfully")}catch(o){throw console.error("Error updating report status:",o),o}})}storePdfForReporte(e,r){return h(this,null,function*(){try{console.log("Storing PDF for report:",e);let t=`reportes_pdf/${e}.pdf`,o=v(this.storage,t),s=r.split(",")[1];yield _(o,s,"base64");let n=yield x(o);return console.log("PDF stored successfully, URL:",n),yield this.updateReporteWithPdfInfo(e,n),n}catch(t){throw console.error("Error storing PDF for report:",t),t}})}getPdfUrlForReporte(e){return h(this,null,function*(){try{console.log("Getting PDF URL for report:",e);let r=u(this.firestore,"Reportes",e),t=yield m(r);if(t.exists()){let a=t.data();if(a.pdfUrl)return console.log("Found PDF URL in report document:",a.pdfUrl),a.pdfUrl}let o=`reportes_pdf/${e}.pdf`,s=v(this.storage,o),n=yield x(s);return yield this.updateReporteWithPdfInfo(e,n),n}catch(r){return console.error("PDF not found or access error:",r),null}})}updateReporteWithPdfInfo(e,r){return h(this,null,function*(){try{let t=u(this.firestore,"Reportes",e);yield F(t,{pdfUrl:r,reportePdfGenerado:!0,fechaGeneracionPdf:new Date}),console.log("Report PDF info updated successfully with URL:",r)}catch(t){throw console.error("Error updating report PDF info:",t),t}})}deletePdfForReporte(e){return h(this,null,function*(){try{let r=`reportes_pdf/${e}.pdf`,t=v(this.storage,r);yield J(t),console.log("PDF deleted successfully")}catch(r){throw console.error("Error deleting PDF:",r),r}})}deleteReporte(e){return h(this,null,function*(){try{let r=yield this.authService.getCurrentUser();if(!r)throw new Error("No hay usuario autenticado");let t=yield m(u(this.firestore,"Usuario",r.uid));if(!t.exists())throw new Error("Usuario no encontrado");if(t.data().Rol!=="admin")throw new Error("Solo los administradores pueden eliminar reportes");let s=u(this.firestore,"Reportes",e);if(!(yield m(s)).exists())throw new Error("El reporte no existe");try{yield this.deletePdfForReporte(e)}catch(a){console.warn("No se pudo eliminar el PDF del reporte:",a)}console.log("Eliminando reporte:",e),yield O(s),console.log("Reporte eliminado exitosamente")}catch(r){throw console.error("Error al eliminar reporte:",r),r}})}assignReporte(e){return h(this,null,function*(){try{console.log("Attempting to assign report with data:",JSON.stringify(e));let r=yield this.authService.getCurrentUser();if(!r)throw new Error("No hay usuario autenticado");let t=yield m(u(this.firestore,"Usuario",r.uid));if(!t.exists())throw new Error("Usuario administrador no encontrado");if(t.data().Rol!=="admin")throw new Error("No tiene permisos para crear reportes");let s=d(this.firestore,"Usuario");console.log("Searching for worker with Username:",e.IdUsuario);let n=f(s,c("Username","==",e.IdUsuario),c("Rol","==","worker")),a=yield E(n);if(a.empty){console.error("Worker not found. Trying alternative search...");let I=f(s,c("Username","==",e.IdUsuario)),A=yield E(I);if(A.empty)throw new Error("Usuario trabajador no encontrado");let j=A.docs[0].id;console.log("Found worker with different role:",j);let $=d(this.firestore,"Reportes"),H={fecha:new Date,estado:"Pendiente",IdEmpresa:e.IdEmpresa,IdUsuario:j,Tipo_Trabajo:e.Tipo_Trabajo,jobDescription:e.jobDescription,location:e.location,priority:e.priority,departamento:e.departamento,fechaActualizacion:new Date},b=yield T($,H);return yield F(u(this.firestore,"Reportes",b.id),{IdReporte:b.id}),console.log("Reporte creado exitosamente:",b.id),b.id}let R=a.docs[0].id;console.log("Found worker:",R);let P=d(this.firestore,"Reportes"),D={fecha:new Date,estado:"Pendiente",IdEmpresa:e.IdEmpresa,IdUsuario:R,Tipo_Trabajo:e.Tipo_Trabajo,jobDescription:e.jobDescription,location:e.location,priority:e.priority,departamento:e.departamento,fechaActualizacion:new Date};console.log("Creating report with data:",JSON.stringify(D));let l=yield T(P,D);return yield F(u(this.firestore,"Reportes",l.id),{IdReporte:l.id}),console.log("Reporte creado exitosamente:",l.id),l.id}catch(r){throw console.error("Error al asignar reporte:",r),r}})}getReportes(){console.log("Obteniendo todos los reportes");let e=d(this.firestore,"Reportes");return w(e,{idField:"IdReporte"}).pipe(g(r=>(console.log("Reportes recuperados:",r),this.processReportDates(r))))}getReportesByDepartamento(e){if(!e)return console.error("Departamento es requerido para obtener reportes"),i([]);console.log("Buscando reportes para departamento:",e);let r=d(this.firestore,"Reportes"),t=f(r,c("departamento","==",e));return w(t,{idField:"IdReporte"}).pipe(g(o=>(console.log("Reportes encontrados para departamento:",o),this.processReportDates(o))))}getReportesByEmpresa(e){if(!e)return console.error("ID de empresa es requerido para obtener reportes"),i([]);console.log("Buscando reportes para empresa:",e);let r=d(this.firestore,"Reportes"),t=f(r,c("IdEmpresa","==",e));return w(t,{idField:"IdReporte"}).pipe(g(o=>(console.log("Reportes encontrados para empresa:",o),this.processReportDates(o))))}getReportesByPriority(e){if(!e)return console.error("Prioridad es requerida para obtener reportes"),i([]);console.log("Buscando reportes por prioridad:",e);let r=d(this.firestore,"Reportes"),t=f(r,c("priority","==",e));return w(t,{idField:"IdReporte"}).pipe(g(o=>(console.log("Reportes encontrados por prioridad:",o),this.processReportDates(o))))}getFilteredReportes(){return h(this,null,function*(){try{let e=yield this.authService.getCurrentUser();if(!e)return console.error("No hay usuario autenticado"),i([]);let r=yield this.authService.getUserData(e.uid);return r?r.Rol==="admin"&&r.NivelAdmin==="3"?this.getReportesByCreator(e.uid):this.getReportes():(console.error("Datos de usuario no encontrados"),i([]))}catch(e){return console.error("Error al filtrar reportes:",e),i([])}})}getReportesByCreator(e){return new N(r=>{this.authService.getUsersByCreator(e).then(t=>{let o=t.map(p=>p.IdUsuario);if(o.length===0){r.next([]),r.complete();return}let s=d(this.firestore,"Reportes"),n=this.chunkArray(o,10),a=[];n.forEach(p=>{let R=f(s,c("IdUsuario","in",p)),P=E(R).then(D=>{let l=[];return D.forEach(I=>{l.push(S({IdReporte:I.id},I.data()))}),this.processReportDates(l)});a.push(P)}),Promise.all(a).then(p=>{let R=p.flat();r.next(R),r.complete()}).catch(p=>{console.error("Error obteniendo reportes:",p),r.error(p)})}).catch(t=>{console.error("Error obteniendo usuarios:",t),r.error(t)})})}chunkArray(e,r){let t=[];for(let o=0;o<e.length;o+=r)t.push(e.slice(o,o+r));return t}static \u0275fac=function(r){return new(r||U)};static \u0275prov=W({token:U,factory:U.\u0275fac,providedIn:"root"})}return U})();export{te as a};
//# sourceMappingURL=chunk-HLO3N466.js.map
