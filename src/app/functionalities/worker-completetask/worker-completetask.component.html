<div class="main-container">
  <!-- Header section -->
  <div class="header">
    <button class="back-button" (click)="goBack()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
    <h1>Reportes Completados</h1>
  </div>

  <!-- Loading and error messages -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando reportes completados...</p>
  </div>

  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="success-message">
    {{ successMessage }}
  </div>

  <!-- Filter section -->
  <div class="filters-container" *ngIf="!isLoading && completedTasks.length > 0">
    <div class="search-container">
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        placeholder="Buscar reportes..." 
        class="search-input"
        (input)="onSearchChange()"
      >
      <i class="fas fa-search search-icon"></i>
    </div>

    <div class="filter-options">
      <div class="filter-select">
        <label for="company-filter">Empresa:</label>
        <select id="company-filter" [(ngModel)]="selectedCompany" (change)="applyFilters()">
          <option value="">Todas</option>
          <option *ngFor="let company of (companies$ | async)" [value]="company.IdEmpresa">
            {{ company.Nombre }}
          </option>
        </select>
      </div>

      <div class="filter-select">
        <label for="date-filter">Fecha:</label>
        <select id="date-filter" [(ngModel)]="selectedDateFilter" (change)="applyFilters()">
          <option value="">Todas las fechas</option>
          <option value="today">Hoy</option>
          <option value="yesterday">Ayer</option>
          <option value="week">Última semana</option>
          <option value="month">Último mes</option>
        </select>
      </div>

      <button class="reset-button" (click)="resetFilters()">
        <i class="fas fa-sync-alt"></i> Resetear filtros
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!isLoading && completedTasks.length === 0" class="empty-state">
    <i class="fas fa-clipboard-check empty-icon"></i>
    <h2>No hay reportes completados</h2>
    <p>Una vez que completes tareas, aparecerán aquí.</p>
  </div>

  <!-- Tasks list -->
  <div class="reports-container" *ngIf="!isLoading && filteredTasks.length > 0">
    <div class="report-card" *ngFor="let report of filteredTasks">
      <div class="report-header">
        <h3 class="report-title">{{ report.Tipo_Trabajo }}</h3>
        <span class="report-status" [ngClass]="getStatusClass(report.estado)">
          {{ report.estado }}
        </span>
      </div>

      <div class="report-info">
        <div class="info-row">
          <span class="info-label">Empresa:</span>
          <span class="info-value">{{ getCompanyName(report.IdEmpresa) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ubicación:</span>
          <span class="info-value">{{ report.location || 'No especificada' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Departamento:</span>
          <span class="info-value">{{ report.departamento || 'No especificado' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Prioridad:</span>
          <span class="info-value priority-tag" [ngClass]="getPriorityClass(report.priority)">
            {{ report.priority || 'Normal' }}
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Fecha completado:</span>
          <span class="info-value">{{ formatDate(report.fechaCompletado) }}</span>
        </div>
      </div>

      <div class="report-description">
        <h4>Descripción del trabajo:</h4>
        <p>{{ report.jobDescription }}</p>
        
        <h4 *ngIf="report.descripcionCompletado">Descripción de la solución:</h4>
        <p *ngIf="report.descripcionCompletado">{{ report.descripcionCompletado }}</p>
      </div>

      <div class="report-features">
        <div class="feature-tag" *ngIf="hasEvidenceImages(report)">
          <i class="fas fa-images"></i> {{ getEvidenceCount(report) }} evidencias
        </div>
        <div class="feature-tag" *ngIf="hasSignature(report)">
          <i class="fas fa-signature"></i> Firmado
        </div>
        <div class="feature-tag" *ngIf="hasMaterials(report)">
          <i class="fas fa-tools"></i> Materiales
        </div>
        <div class="feature-tag" *ngIf="report.reportePdfGenerado">
          <i class="fas fa-file-pdf"></i> PDF disponible
        </div>
      </div>

      <div class="report-actions">
        <button class="action-button view-button" *ngIf="report.reportePdfGenerado" (click)="openPdfViewer(report)">
          <i class="fas fa-eye"></i> Ver PDF
        </button>
        <button class="action-button download-button" *ngIf="report.reportePdfGenerado" (click)="startDownload(report)">
          <i class="fas fa-download"></i> Descargar PDF
        </button>
      </div>
    </div>
  </div>

  <!-- PDF Viewer Modal -->
  <div class="pdf-modal" *ngIf="showPdfViewer">
    <div class="pdf-modal-content">
      <div class="pdf-modal-header">
        <h2>Vista previa del PDF</h2>
        <button class="close-button" (click)="closePdfViewer()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="pdf-container" *ngIf="!isLoading && pdfUrl">
        <pdf-viewer [src]="pdfUrl" 
                   [render-text]="true"
                   [original-size]="false"
                   [show-all]="true"
                   [fit-to-page]="true"
                   [zoom]="1"
                   style="width: 100%; height: 80vh;">
        </pdf-viewer>
      </div>
      <div class="loading-container" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Cargando PDF...</p>
      </div>
      <div class="pdf-modal-footer">
        <button class="action-button download-button" *ngIf="selectedReport && !isLoading" (click)="startDownload(selectedReport)">
          <i class="fas fa-download"></i> Descargar PDF
        </button>
        <button class="action-button close-button" (click)="closePdfViewer()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>