import{a as z}from"./chunk-P5C6PN4L.js";import{M as S,O as f,P as F,Q as i,R as j,S as R,T as w,U as C,W as d,Y as k,Z as n}from"./chunk-5O2P5WTG.js";import{T as A,Z as I,c as b,o as p,s as h}from"./chunk-F77T7Y3R.js";import{a as U,b as B,g as E}from"./chunk-OIKEWKHE.js";var W=(()=>{class D{firestore=I(S);authService=I(z);assignReporte(r){return E(this,null,function*(){try{let e=yield this.authService.getCurrentUser();if(!e)throw new Error("No hay usuario autenticado");let t=yield w(R(this.firestore,"Usuario",e.uid));if(!t.exists())throw new Error("Usuario administrador no encontrado");if(t.data().Rol!=="admin")throw new Error("No tiene permisos para crear reportes");let c=i(this.firestore,"Usuario"),u=d(c,n("Username","==",r.IdUsuario),n("Rol","==","worker")),l=yield C(u);if(l.empty)throw new Error("Usuario trabajador no encontrado");let m=l.docs[0].id,g=i(this.firestore,"Reportes"),y={fecha:new Date,estado:"Pendiente",IdEmpresa:r.IdEmpresa,IdUsuario:m,Tipo_Trabajo:r.Tipo_Trabajo,jobDescription:r.jobDescription,location:r.location,priority:r.priority,departamento:r.departamento,fechaActualizacion:new Date},a=yield F(g,y);return yield k(R(this.firestore,"Reportes",a.id),{IdReporte:a.id}),console.log("Reporte creado exitosamente:",a.id),a.id}catch(e){throw console.error("Error al asignar reporte:",e),e}})}getReportes(){console.log("Obteniendo todos los reportes");let r=i(this.firestore,"Reportes");return f(r,{idField:"IdReporte"}).pipe(h(e=>(console.log("Reportes recuperados:",e),this.processReportes(e))))}getPendingReportesByWorker(r){if(!r)return console.error("UserId es requerido para obtener reportes pendientes"),p([]);console.log("Buscando reportes pendientes para userId:",r);let e=i(this.firestore,"Reportes"),t=d(e,n("IdUsuario","==",r),n("estado","==","Pendiente"));return f(t,{idField:"IdReporte"}).pipe(h(o=>(console.log("Reportes pendientes encontrados:",o),this.processReportes(o))))}getCompletedReportesByWorker(r){if(!r)return console.error("UserId es requerido para obtener reportes completados"),p([]);console.log("Buscando reportes completados para userId:",r);let e=i(this.firestore,"Reportes"),t=d(e,n("IdUsuario","==",r),n("estado","==","Completado"));return f(t,{idField:"IdReporte"}).pipe(h(o=>(console.log("Reportes completados encontrados:",o),this.processReportes(o))))}updateReporteStatus(r,e,t){return E(this,null,function*(){try{let o=yield this.authService.getCurrentUser();if(!o)throw new Error("No hay usuario autenticado");let c=R(this.firestore,"Reportes",r),u=yield w(c);if(!u.exists())throw new Error("El reporte no existe");let l=u.data(),s=yield w(R(this.firestore,"Usuario",o.uid));if(!s.exists())throw new Error("Usuario no encontrado");let g=s.data().Rol==="admin",y=l.IdUsuario===o.uid;if(!g&&!y)throw new Error("No tiene permisos para actualizar este reporte");let a={estado:e,fechaActualizacion:new Date};e==="Completado"&&(a.fechaCompletado=new Date,t&&(a.descripcionCompletado=t)),yield k(c,a),console.log("Estado del reporte actualizado exitosamente")}catch(o){throw console.error("Error al actualizar estado del reporte:",o),o}})}deleteReporte(r){return E(this,null,function*(){try{let e=yield this.authService.getCurrentUser();if(!e)throw new Error("No hay usuario autenticado");let t=yield w(R(this.firestore,"Usuario",e.uid));if(!t.exists())throw new Error("Usuario no encontrado");if(t.data().Rol!=="admin")throw new Error("Solo los administradores pueden eliminar reportes");let c=R(this.firestore,"Reportes",r);if(!(yield w(c)).exists())throw new Error("El reporte no existe");console.log("Eliminando reporte:",r),yield j(c),console.log("Reporte eliminado exitosamente")}catch(e){throw console.error("Error al eliminar reporte:",e),e}})}processReportes(r){return r.map(e=>B(U({},e),{fecha:e.fecha?.toDate?.()||new Date(e.fecha),fechaCompletado:e.fechaCompletado?.toDate?.()||(e.fechaCompletado?new Date(e.fechaCompletado):void 0),fechaActualizacion:e.fechaActualizacion?.toDate?.()||(e.fechaActualizacion?new Date(e.fechaActualizacion):new Date)}))}getReportesByDepartamento(r){if(!r)return console.error("Departamento es requerido para obtener reportes"),p([]);console.log("Buscando reportes para departamento:",r);let e=i(this.firestore,"Reportes"),t=d(e,n("departamento","==",r));return f(t,{idField:"IdReporte"}).pipe(h(o=>(console.log("Reportes encontrados para departamento:",o),this.processReportes(o))))}getReportesByEmpresa(r){if(!r)return console.error("ID de empresa es requerido para obtener reportes"),p([]);console.log("Buscando reportes para empresa:",r);let e=i(this.firestore,"Reportes"),t=d(e,n("IdEmpresa","==",r));return f(t,{idField:"IdReporte"}).pipe(h(o=>(console.log("Reportes encontrados para empresa:",o),this.processReportes(o))))}getReportesByPriority(r){if(!r)return console.error("Prioridad es requerida para obtener reportes"),p([]);console.log("Buscando reportes por prioridad:",r);let e=i(this.firestore,"Reportes"),t=d(e,n("priority","==",r));return f(t,{idField:"IdReporte"}).pipe(h(o=>(console.log("Reportes encontrados por prioridad:",o),this.processReportes(o))))}getFilteredReportes(){return E(this,null,function*(){try{let r=yield this.authService.getCurrentUser();if(!r)return console.error("No hay usuario autenticado"),p([]);let e=yield this.authService.getUserData(r.uid);return e?e.Rol==="admin"&&e.NivelAdmin==="3"?this.getReportesByCreator(r.uid):this.getReportes():(console.error("Datos de usuario no encontrados"),p([]))}catch(r){return console.error("Error al filtrar reportes:",r),p([])}})}getReportesByCreator(r){return new b(e=>{this.authService.getUsersByCreator(r).then(t=>{let o=t.map(s=>s.IdUsuario);if(o.length===0){e.next([]),e.complete();return}let c=i(this.firestore,"Reportes"),u=this.chunkArray(o,10),l=[];u.forEach(s=>{let m=d(c,n("IdUsuario","in",s)),g=C(m).then(y=>{let a=[];return y.forEach(x=>{a.push(U({IdReporte:x.id},x.data()))}),this.processReportes(a)});l.push(g)}),Promise.all(l).then(s=>{let m=s.flat();e.next(m),e.complete()}).catch(s=>{console.error("Error obteniendo reportes:",s),e.error(s)})}).catch(t=>{console.error("Error obteniendo usuarios:",t),e.error(t)})})}chunkArray(r,e){let t=[];for(let o=0;o<r.length;o+=e)t.push(r.slice(o,o+e));return t}static \u0275fac=function(e){return new(e||D)};static \u0275prov=A({token:D,factory:D.\u0275fac,providedIn:"root"})}return D})();export{W as a};
//# sourceMappingURL=chunk-LQAXUOUF.js.map
